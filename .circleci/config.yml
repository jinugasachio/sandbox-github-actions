version: 2.1

executors:
  terraform:
    resource_class: small
    shell: /bin/bash -eo pipefail
    working_directory: /terraform-workspace-type
    docker:
      - image: jinugasachio/circleci-terraform:1.1.2

commands:
  export_aws_credentials:
    steps:
      - run:
          name: Export AWS credentials
          command: ./scripts/circleci/export_credentials.sh
  run_terraform_init:
    steps:
      - run:
          name: Run terraform init
          command: |
            changed_dirs=$(./scripts/circleci/detect_changed_dirs.sh)
            ./scripts/circleci/terraform_init.sh $changed_dirs
  run_terraform_validate:
    steps:
      - run:
          name: Run terraform validate
          command: |
            changed_dirs=$(./scripts/circleci/detect_changed_dirs.sh)
            ./scripts/circleci/terraform_validate.sh $changed_dirs
  run_terraform_plan:
    steps:
      - run:
          name: Run terraform plan
          command: |
            changed_dirs=$(./scripts/circleci/detect_changed_dirs.sh)
            ./scripts/circleci/terraform_plan.sh $changed_dirs
  run_terraform_apply:
    steps:
      - run:
          name: Run terraform apply
          command: |
            changed_dirs=$(./scripts/circleci/detect_changed_dirs.sh)
            ./scripts/circleci/terraform_apply.sh $changed_dirs

jobs:
  security_check:
    executor: terraform
    steps:
      - checkout
      - run:
          name: Run tfsec
          command: tfsec --force-all-dirs --config-file ./.tfsec/config.yml # この命名規則であれば自動で読み込まれるが明示しておく https://aquasecurity.github.io/tfsec/v0.63.1/getting-started/configuration/config/

  assume_role:
    executor: terraform
    steps:
      - checkout
      - run: 
          name: Assume role
          command: ./scripts/circleci/assume_role.sh
      - persist_to_workspace: # GAと違いCircleCIでは動的なmatrix buildができなそうなのでworkspace使う必要は本当はない
          root: /tmp
          paths:
            - aws_sts_credentials.json

  terraform_fmt:
    executor: terraform
    steps:
      - checkout
      - run:
          name: Run terraform fmt
          command: terraform fmt -diff -check -recursive .

  lint:
    executor: terraform
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - export_aws_credentials
      - run: curl --help
      - run:
          name: Run tflint init
          command: tflint --init --config ./.tflint.hcl
      - run:
          name: Run tflint
          command: |
            changed_dirs=$(./scripts/circleci/detect_changed_dirs.sh)
            ./scripts/circleci/tflint.sh $changed_dirs

  terraform_plan:
    executor: terraform
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - export_aws_credentials
      - run_terraform_init
      - run_terraform_validate
      - run_terraform_plan
  
  terraform_apply:
    executor: terraform
    steps:
      - checkout
      - attach_workspace:
          at: /tmp
      - export_aws_credentials
      - run_terraform_init
      - run_terraform_validate
      - run_terraform_apply
      - run_terraform_plan # apply後に差分がないことを確認したい
  
workflows:
  version: 2
  terraform_workflow:
    jobs:
      - security_check
      - terraform_fmt
      - assume_role
      - lint:
          requires:
            - assume_role
      - terraform_plan:
          requires:
            - assume_role
      - approve:
          type: approval
          requires:
            - security_check
            - terraform_fmt
            - lint
            - terraform_plan
          filters:
            branches:
              ignore: main
      - terraform_apply:
          requires:
            - approve